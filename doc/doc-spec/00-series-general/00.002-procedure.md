# 00.002 Procedure

## 1. Controller Start/Stop

Befor Sartup, controller should prepare:

- Access Public/Private Key
- Certificate Public/Private Key
- Root Certificate
- Intermediate Certificate

### 1.1 Controller Start

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant nsf as NSF
    participant drf as DRF
    participant oam as OAM

    nsf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
    nsf -->>- nsf: NNSF_NF_REGISTERATION_RESPONSE

    par
        amf ->>+ nsf: NNSF_NF_REGISTERATIONR_REQUEST
        nsf -->>- amf: NNSF_NF_REGISTERATION_RESPONSE
    and
        smf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- smf: NNSF_NF_REGISTERATION_RESPONSE
    and
        pkf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- pkf: NNSF_NF_REGISTERATION_RESPONSE
    and
        drf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- drf: NNSF_NF_REGISTERATION_RESPONSE
    and
        oam ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- oam: NNSF_NF_REGISTERATION_RESPONSE
    end

    Note over amf, oam: NF Event Subscribe
```

### 1.2 Controller Stop

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant nsf as NSF
    participant drf as DRF
    participant oam as OAM

    par
        oam ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- oam: NNSF_NF_DE_REGISTERATION_RESPONSE
    and
        drf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- drf: NNSF_NF_DE_REGISTERATION_RESPONSE
    and
        pkf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- pkf: NNSF_NF_DE_REGISTERATION_RESPONSE
    and
        smf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- smf: NNSF_NF_DE_REGISTERATION_RESPONSE
    and
        amf ->>+ nsf: NNSF_NF_DE_REGISTERATIONR_REQUEST
        nsf -->>- amf: NNSF_NF_DE_REGISTERATIONR_RESPONSE
    end

    nsf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
    nsf -->>- nsf: NNSF_NF_DE_REGISTERATION_RESPONSE
```

## 2. NF Start/Stop

### 2.1 NF Start

```mermaid
graph LR
    Y(NF Started)
    Z(Exit)

    A(Start NF) -->  B[Load Configurations]
    B -- Success --> C[Logger Setup]
    B -- Fail --> Z
    C -- Success --> D[Start SBI Server]
    C -- Fail --> Z
    D -- Success --> E[Register to NSF]
    D -- Fail --> Z
    E -- Success --> F{Has NX Interface?}
    E -- Fail --> Z
    F -- Yes --> G[Setup NX Interface]
    F -- No --> Y
    G -- Success --> Y
    G -- Faile --> Z
```

### 2.2 NF Stop

```mermaid
graph LR
    Z(NF Stopped)

    A(Stop NF) --> B{Has NX Interface}
    B -- Yes --> C[Close NX Interface]
    B -- No --> D[De-register to NSF]
    C --> D
    D --> E[Stop SBI Server]
    E --> Z
```

## 3. NF Service Access

```mermaid
sequenceDiagram
    autonumber
    participant con as Consumer
    participant nsf as NSF
    participant pro as Processor

    con ->>+ nsf: NNSF_NF_DISCOVERY_REQUEST
    nsf -->>- con: NNSF_NF_DISCOVERY_RESPONSE
    con ->>+ pro: NXXX_SERVICE_REQUEST
    pro -->>- con: NXXX_SERVICE_RESPONSE
```

## 4. Identity Initialization/Registeration/De-registeration

### 4.1 Identity Initialization

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF
    participant oam as OAM

    id ->>+ oam: JWT Download Request
    oam ->>+ drf: NDRF_JWT_QUERY_REQUEST
    drf -->>- oam: NDRF_JWT_QUERY_RESPONSE
    oam -->>- id: JWT Download RESPONSE

    id ->>+ amf: IAP_INITIALZATION_REQUEST
    amf ->>+ drf: NDRF_JWT_QUERY_REQUEST
    drf -->>- amf: NDRF_JWT_QUERY_RESPONSE
    amf ->>+ pkf: NPKF_JWT_VALIDATION_REQUEST
    pkf ->>+ drf: NDRF_JWT_DELETE_REQUEST
    drf -->>- pkf: NDRF_JWT_DELETE_RESPONSE
    pkf -->>- amf: NPKF_JWT_VALIDATION_RESPONSE
    amf ->>+ pkf: NPKF_CERT_GENERATION_REQUEST
    pkf -->>- amf: NPKF_CERT_GENERATION_RESPONSE
    amf -->>- id: IAP_INITIALZATION_RESPONSE
```

### 4.2 Identity Registration

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF

    id ->>+ amf: IAP_REGISTRATION_REQUEST
    amf ->>+ pkf: NPKF_PUBLIC_KEY_QUERY_REQUEST
    pkf -->>- amf: NPKF_PUBLIC_KEY_QUERY_RESPONSE
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_RESPONSE
    amf ->>+ drf: NDRF_SESSION_DATA_QUERY_REQUEST
    drf -->>- amf: NDRF_SESSION_DATA_QUERY_RESPONSE
    amf -->>- id: IAP_REGISTRATION_RESPONSE
```

### 4.3 Identity De-registration

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF

    id ->>+ amf: IAP_DE_REGISTRATION_REQUEST
    amf ->>+ pkf: NPKF_PUBLIC_KEY_QUERY_REQUEST
    pkf -->>- amf: NPKF_PUBLIC_KEY_QUERY_RESPONSE
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_RESPONSE
    amf -->>- id: IAP_DE_REGISTRATION_RESPONSE
```

## 5. Router Session Establishment/Release

### 5.1 Router Session Establishment

```mermaid
sequenceDiagram
    autonumber

    participant rt as Router
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF

    rt ->>+ smf: RAP_SESSION_ESTABLISHMENT_REQUEST
    smf ->>+ pkf: NPKF_PUBLIC_KEY_QUERY_REQUEST
    pkf -->>- smf: NPKF_PUBLIC_KEY_QUERY_RESPONSE
    smf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- smf: NPKF_CERT_VALIDATION_RESPONSE
    smf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- smf: NDRF_IDENTITY_UPDATE_RESPONSE
    smf -->>- rt: RAP_SESSION_ESTABLISHMENT_RESPONSE

    Note over rt, smf: Router Session Establishment
    Note over rt, smf: Router Session Heartbeat
```

### 5.2 Router Session Release

```mermaid
sequenceDiagram
    autonumber

    participant rt as Router
    participant smf as SMF
    participant pkf as PKF

    rt ->>+ smf: RAP_SESSION_RELEASE_REQUEST
    smf ->>+ pkf: NPKF_PUBLIC_KEY_QUERY_REQUEST
    pkf -->>- smf: NPKF_PUBLIC_KEY_QUERY_RESPONSE
    smf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- smf: NPKF_CERT_VALIDATION_RESPONSE``
    smf -->>- rt: RAP_SESSION_RELEASE_RESPONSE

    Note over rt, smf: Router Session Release
```

## 6. Session Establishment/Modification/Release

### 6.1 Session Establishment

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF
    participant rt as Router

    id ->>+ amf: IAP_SESSION_ESTABLISHMENT_REQUEST
    amf ->>+ pkf: NPKF_PUBLIC_KEY_QUERY_REQUEST
    pkf -->>- amf: NPKF_PUBLIC_KEY_QUERY_RESPONSE
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_RESPONSE
    amf ->>+ smf: NSMF_SESSION_ESTABLISHMENT_REQUEST
    smf ->>+ drf: NDRF_SESSION_DATA_QUERY_REQUEST
    drf -->>- smf: NDRF_SESSION_DATA_QUERY_RESPONSE
    smf ->>+ rt: SMP_SESSION_ESTABLISHMENT_REQUEST
    rt -->>- smf: SMP_SESSION_ESTABLISHMENT_RESPONSE
    smf -->>- amf: NSMF_SESSION_ESTABLISHMENT_RESPONSE
    amf -->>- id: IAP_SESSION_ESTABLISHMENT_RESPONSE
```

### 6.2 Session Modification

```mermaid
sequenceDiagram
    autonumber

    participant smf as SMF
    participant drf as DRF
    participant oam as OAM
    participant mrt as Modify-Router
    participant ert as Establish-Router
    participant rrt as Release-Router

    oam ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- oam: NDRF_IDENTITY_UPDATE_
    oam ->>+ smf: NSMF_SESSION_UPDATE_REQUEST
    smf ->>+ drf: NDRF_SESSION_DATA_QUERY_REQUEST
    drf -->>- smf: NDRF_SESSION_DATA_QUERY_RESPONSE
    par
        smf ->>+ mrt: SMP_SESSION_MODIFY_REQUEST
        mrt -->>- smf: SMP_SESSION_MODIFY_RESPONSE
    and
        smf ->>+ ert: SMP_SESSION_ESTABLISHMENT_REQUEST
        ert -->>- smf: SMP_SESSION_ESTABLISHMENT_RESPONSE
    and
        smf ->>+ rrt: SMP_SESSION_RELEASE_REQUEST
        rrt -->>- smf: SMP_SESSION_RELEASE_RESPONSE
    end
    smf -->>- oam: NSMF_SESSION_UPDATE_RESPONSE
```

### 6.3 Session Release

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF
    participant rt as Router

    id ->>+ amf: IAP_SESSION_RELEASE_REQUEST
    amf ->>+ pkf: NPKF_PUBLIC_KEY_QUERY_REQUEST
    pkf -->>- amf: NPKF_PUBLIC_KEY_QUERY_RESPONSE
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_RESPONSE
    amf ->>+ smf: NSMF_SESSION_RELEASE_REQUEST
    smf ->>+ rt: SMP_SESSION_RELEASE_REQUEST
    rt -->>- smf: SMP_SESSION_RELEASE_RESPONSE
    smf -->>- amf: NSMF_SESSION_RELEASE_RESPONSE
    amf -->>- id: IAP_SESSION_RELEASE_RESPONS
```

## 7. OAM Interaction

### 7.1 Identity Creation/Modification/Delete

#### 7.1.1 Identity Creation

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF
    participant pkf as PKF

    oam ->>+ drf: NDRF_IDENTITY_INSERT_RQUEST
    drf -->>- oam: NDRF_IDENTITY_INSERT_RESPONSE
    oam ->>+ pkf: NPKF_JWT_GENERATION_REQUEST
    pkf -->>- oam: NPKF_JWT_GENERATION_RESPONSE
    oam ->>+ drf: NDRF_JWT_INSERT_REQUEST
    drf -->>- oam: NDRF_JWT_INSERT_RESPONSE
```

#### 7.1.2 Identity Get

##### 7.1.2.1 Single Identity Get

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF


    oam ->>+ drf: NDRF_IDENTITY_QUERY_RQUEST
    drf -->>- oam: NDRF_IDENTITY_QUERY_RESPONSE
```

##### 7.1.2.2 Single Identities Get

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF


    oam ->>+ drf: NDRF_IDENTITIES_QUERY_RQUEST
    drf -->>- oam: NDRF_IDENTITIES_QUERY_RESPONSE
```

#### 7.1.3 Identity Modification

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF


    oam ->>+ drf: NDRF_IDENTITY_UPDATE_RQUEST
    drf -->>- oam: NDRF_IDENTITY_UPDATE_RESPONSE
```

#### 7.1.4 Identity Delete

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF
    oam ->>+ drf: NDRF_IDENTITY_DELETE_RQUEST
    drf -->>- oam: NDRF_IDENTITY_DELETE_RESPONSE
```

### 7.2 Status Monitoring

#### 7.2.1 NF Event Subscribe/Receive/Modify

##### 7.2.1.1 NF Event Subscribe

```mermaid
sequenceDiagram
    autonumber

    participant nf as NF
    participant oam as OAM

    oam ->>+ nf: NXXX_EVENT_SUBSCRIBE_REQUEST
    nf -->>- oam: NXXX_EVENT_SUBSCRIBE_RESPONSE
```

##### 7.2.1.2 NF Event Receive

```mermaid
sequenceDiagram
    autonumber

    participant nf as NF
    participant oam as OAM

    nf ->>+ oam: NOAM_EVENT_CALLBACK_REQUEST
    oam -->>- nf: NOAM_EVENT_CALLBACK_RESPONSE
```

##### 7.2.1.3 NF Event Update

```mermaid
sequenceDiagram
    autonumber

    participant nf as NF
    participant oam as OAM

    oam ->>+ nf: NXXX_EVENT_MODIFY_REQUEST
    nf -->>- oam: NXXX_EVENT_MODIFY_RESPONSE
```

#### 7.2.2 Identity

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant oam as OAM

    oam ->>+ amf: NAMF_IDENTITIES_QUERY_REQUEST
    amf -->>- oam: NAMF_IDENTITIES_QUERY_RESPONSE
```

#### 7.2.3 Router

```mermaid
sequenceDiagram
    autonumber

    participant smf as SMF
    participant oam as OAM

    oam ->>+ smf: NSMF_ROUTERS_QUERY_REQUEST
    smf -->>- oam: NSMF_ROUTERS_QUERY_RESPONSE
```
