# 00.002 Procedure

## 1. Controller Start/Stop

### 1.1 Controller Start

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant nsf as NSF
    participant drf as DRF
    participant oam as OAM

    nsf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
    nsf -->>- nsf: NNSF_NF_REGISTERATION_REPLY

    par
        amf ->>+ nsf: NNSF_NF_REGISTERATIONR_REQUEST
        nsf -->>- amf: NNSF_NF_REGISTERATION_REPLY
    and
        smf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- smf: NNSF_NF_REGISTERATION_REPLY
    and
        pkf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- pkf: NNSF_NF_REGISTERATION_REPLY
    and
        drf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- drf: NNSF_NF_REGISTERATION_REPLY
    and
        oam ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- oam: NNSF_NF_REGISTERATION_REPLY
    end

    Note over amf, oam: NF Event Subscribe
```

### 1.2 Controller Stop

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant nsf as NSF
    participant drf as DRF
    participant oam as OAM

    par
        oam ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- oam: NNSF_NF_DE_REGISTERATION_REPLY
    and
        drf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- drf: NNSF_NF_DE_REGISTERATION_REPLY
    and
        pkf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- pkf: NNSF_NF_DE_REGISTERATION_REPLY
    and
        smf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- smf: NNSF_NF_DE_REGISTERATION_REPLY
    and
        amf ->>+ nsf: NNSF_NF_DE_REGISTERATIONR_REQUEST
        nsf -->>- amf: NNSF_NF_DE_REGISTERATIONR_REPLY
    end

    nsf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
    nsf -->>- nsf: NNSF_NF_DE_REGISTERATION_REPLY
```

## 2. NF Start/Stop

### 2.1 NF Start

```mermaid
graph LR
    Y(NF Started)
    Z(Exit)

    A(Start NF) -->  B[Load Configurations]
    B -- Success --> C[Logger Setup]
    B -- Fail --> Z
    C -- Success --> D[Start SBI Server]
    C -- Fail --> Z
    D -- Success --> E[Register to NSF]
    D -- Fail --> Z
    E -- Success --> F{Has NX Interface?}
    E -- Fail --> Z
    F -- Yes --> G[Setup NX Interface]
    F -- No --> Y
    G -- Success --> Y
    G -- Faile --> Z
```

### 2.2 NF Stop

```mermaid
graph LR
    Z(NF Stopped)

    A(Stop NF) --> B{Has NX Interface}
    B -- Yes --> C[Close NX Interface]
    B -- No --> D[De-register to NSF]
    C --> D
    D --> E[Stop SBI Server]
    E --> Z
```

## 3. NF Service Access

```mermaid
sequenceDiagram
    autonumber
    participant con as Consumer
    participant nsf as NSF
    participant pro as Processor

    con ->>+ nsf: NNSF_NF_DISCOVERY_REQUEST
    nsf -->>- con: NNSF_NF_DISCOVERY_REPLY
    con ->>+ pro: NXXX_SERVICE_REQUEST
    pro -->>- con: NXXX_SERVICE_REPLY
```

## 4. Identity Initialization/Registeration/De-registeration

### 4.1 Identity Initialization

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF
    participant oam as OAM

    id ->>+ oam: JWT Download Request
    oam ->>+ drf: NDRF_JWT_QUERY_REQUEST
    drf -->>- oam: NDRF_JWT_QUERY_REPLY
    oam -->>- id: JWT Download Reply

    id ->>+ amf: IAP_INITIALZATION_REQUEST
    amf ->>+ pkf: NPKF_JWT_VALIDATION_REQUEST
    pkf ->>+ drf: NDRF_JWT_DELETE_REQUEST
    drf -->>- pkf: NDRF_JWT_DELETE_REPLY
    pkf -->>- amf: NPKF_JWT_VALIDATION_REPLY
    amf ->>+ pkf: NPKF_CERT_GENERATION_REQUEST
    pkf -->>- amf: NPKF_CERT_GENERATION_REPLY
    amf -->>- id: IAP_INITIALZATION_REPLY
```

### 4.2 Identity Registration

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_REGISTRATION_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_REPLY
    amf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- amf: NDRF_IDENTITY_UPDATE_REPLY
    amf -->>- id: IAP_REGISTRATION_REPLY
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

### 4.3 Identity De-registration

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_DE_REGISTRATION_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_REPLY
    amf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- amf: NDRF_IDENTITY_UPDATE_REPLY
    amf -->>- id: IAP_DE_REGISTRATION_REPLY
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

## 5. Router Session Establishment/Release

### 5.1 Router Session Establishment

```mermaid
sequenceDiagram
    autonumber

    participant rt as Router
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF

    Note over rt, smf: Establish Secure Channel (TLS 1.3)
    rt ->>+ smf: RAP_SESSION_ESTABLISHMENT_REQUEST
    smf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- smf: NPKF_CERT_VALIDATION_REPLY
    smf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- smf: NDRF_IDENTITY_UPDATE_REPLY
    smf -->>- rt: RAP_SESSION_ESTABLISHMENT_REPLY
    Note over rt, smf: Release Secure Channel (TLS 1.3)
    Note over rt, smf: Router Session Establishment
    Note over rt, smf: Router Session Heartbeat
```

### 5.2 Router Session Release

```mermaid
sequenceDiagram
    autonumber

    participant rt as Router
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF

    Note over rt, smf: Establish Secure Channel (TLS 1.3)
    rt ->>+ smf: RAP_SESSION_RELEASE_REQUEST
    smf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- smf: NPKF_CERT_VALIDATION_REPLY
    smf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- smf: NDRF_IDENTITY_UPDATE_REPLY
    smf -->>- rt: RAP_SESSION_RELEASE_REPLY
    Note over rt, smf: Release Secure Channel (TLS 1.3)
    Note over rt, smf: Router Session Release
```

## 6. Session Establishment/Modification/Release

### 6.1 Session Establishment

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF
    participant rt as Router

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_SESSION_ESTABLISHMENT_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_REPLY
    amf ->>+ smf: NSMF_SESSION_ESTABLISHMENT_REQUEST
    smf ->>+ drf: NDRF_SESSION_DATA_REQUEST
    drf -->>- smf: NDRF_SESSION_DATA_REPLY
    smf ->>+ rt: SMP_SESSION_ESTABLISHMENT_REQUEST
    rt -->>- smf: SMP_SESSION_ESTABLISHMENT_REPLY
    smf -->>- amf: NSMF_SESSION_ESTABLISHMENT_REPLY
    amf -->>- id: IAP_SESSION_ESTABLISHMENT_REPLY
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

### 6.2 Session Modification

```mermaid
sequenceDiagram
    autonumber

    participant smf as SMF
    participant drf as DRF
    participant oam as OAM
    participant mrt as Modify-Router
    participant ert as Establish-Router
    participant rrt as Release-Router

    oam ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- oam: NDRF_IDENTITY_UPDATE_
    oam ->>+ smf: NSMF_SESSION_UPDATE_REQUEST
    smf ->>+ drf: NDRF_SESSION_DATA_REQUEST
    drf -->>- smf: NDRF_SESSION_DATA_REPLY
    par
        smf ->>+ mrt: SMP_SESSION_MODIFY_REQUEST
        mrt -->>- smf: SMP_SESSION_MODIFY_REPLY
    and
        smf ->>+ ert: SMP_SESSION_ESTABLISHMENT_REQUEST
        ert -->>- smf: SMP_SESSION_ESTABLISHMENT_REPLY
    and
        smf ->>+ rrt: SMP_SESSION_RELEASE_REQUEST
        rrt -->>- smf: SMP_SESSION_RELEASE_REPLY
    end
    smf -->>- oam: NSMF_SESSION_UPDATE_REPLY
```

### 6.3 Session Release

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant rt as Router

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_SESSION_RELEASE_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_REPLY
    amf ->>+ smf: NSMF_SESSION_RELEASE_REQUEST
    smf ->>+ rt: SMP_SESSION_RELEASE_REQUEST
    rt -->>- smf: SMP_SESSION_RELEASE_REPLY
    smf -->>- amf: NSMF_SESSION_RELEASE_REPLY
    amf -->>- id: IAP_SESSION_RELEASE_REPLY
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

## 7. OAM Interaction

### 7.1 Identity Creation/Modification/Delete

#### 7.1.1 Identity Creation

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF
    participant pkf as PKF

    oam ->>+ drf: NDRF_IDENTITY_INSERT_RQUEST
    drf -->>- oam: NDRF_IDENTITY_INSERT_REPLY
    oam ->>+ pkf: NPKF_JWT_GENERATION_REQUEST
    pkf -->>- oam: NPKF_JWT_GENERATION_REPLY
    oam ->>+ drf: NDRF_JWT_INSERT_REQUEST
    drf -->>- oam: NDRF_JWT_INSERT_REPLY
```

#### 7.1.2 Identity Modification

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF


    oam ->>+ drf: NDRF_IDENTITY_UPDATE_RQUEST
    drf -->>- oam: NDRF_IDENTITY_UPDATE_REPLY
```

#### 7.1.3 Identity Delete

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF
    oam ->>+ drf: NDRF_IDENTITY_DELETE_RQUEST
    drf -->>- oam: NDRF_IDENTITY_DELETE_REPLY
```

### 7.2 Status Monitoring

#### 7.2.1 NF Event Subscribe/Receive/Modify

##### 7.2.1.1 NF Event Subscribe

```mermaid
sequenceDiagram
    autonumber

    participant nf as NF
    participant oam as OAM

    oam ->>+ nf: NXXX_EVENT_SUBSCRIBE_REQUEST
    nf -->>- oam: NXXX_EVENT_SUBSCRIBE_REPLY
```

##### 7.2.1.2 NF Event Receive

```mermaid
sequenceDiagram
    autonumber

    participant nf as NF
    participant oam as OAM

    nf ->>+ oam: NOAM_EVENT_CALLBACK_REQUEST
    oam -->>- nf: NOAM_EVENT_CALLBACK_REPLY
```

##### 7.2.1.3 NF Event Update

```mermaid
sequenceDiagram
    autonumber

    participant nf as NF
    participant oam as OAM

    oam ->>+ nf: NXXX_EVENT_MODIFY_REQUEST
    nf -->>- oam: NXXX_EVENT_MODIFY_REPLY
```

#### 7.2.2 Identity

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant oam as OAM

    oam ->>+ amf: NAMF_IDENTITIES_QUERY_REQUEST
    amf -->>- oam: NAMF_IDENTITIES_QUERY_REPLY
```

#### 7.2.3 Router

```mermaid
sequenceDiagram
    autonumber

    participant smf as SMF
    participant oam as OAM

    oam ->>+ smf: NSMF_ROUTERS_QUERY_REQUEST
    smf -->>- oam: NAMF_ROUTERS_QUERY_REPLY
```

## 8. QUIC Forward
