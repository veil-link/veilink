# 00.002 Procedure

## 1. Controller Start/Stop

### 1.1 Controller Start

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant nsf as NSF
    participant drf as DRF
    participant oam as OAM

    nsf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
    nsf -->>- nsf: NNSF_NF_REGISTERATION_ACCEPT

    par
        amf ->>+ nsf: NNSF_NF_REGISTERATIONR_REQUEST
        nsf -->>- amf: NNSF_NF_REGISTERATION_ACCEPT
    and
        smf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- smf: NNSF_NF_REGISTERATION_ACCEPT
    and
        pkf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- pkf: NNSF_NF_REGISTERATION_ACCEPT
    and
        drf ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- drf: NNSF_NF_REGISTERATION_ACCEPT
    and
        oam ->>+ nsf: NNSF_NF_REGISTERATION_REQUEST
        nsf -->>- oam: NNSF_NF_REGISTERATION_ACCEPT
    end
```

### 1.2 Controller Stop

```mermaid
sequenceDiagram
    autonumber

    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant nsf as NSF
    participant drf as DRF
    participant oam as OAM

    par
        oam ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- oam: NNSF_NF_DE_REGISTERATION_ACCEPT
    and
        drf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- drf: NNSF_NF_DE_REGISTERATION_ACCEPT
    and
        pkf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- pkf: NNSF_NF_DE_REGISTERATION_ACCEPT
    and
        smf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
        nsf -->>- smf: NNSF_NF_DE_REGISTERATION_ACCEPT
    and
        amf ->>+ nsf: NNSF_NF_DE_REGISTERATIONR_REQUEST
        nsf -->>- amf: NNSF_NF_DE_REGISTERATIONR_ACCEPT
    end

    nsf ->>+ nsf: NNSF_NF_DE_REGISTERATION_REQUEST
    nsf -->>- nsf: NNSF_NF_DE_REGISTERATION_ACCEPT
```

## 2. NF Start/Stop

### 2.1 NF Start

```mermaid
graph LR
    Y(NF Started)
    Z(Exit)

    A(Start NF) -->  B[Load Configurations]
    B -- Success --> C[Logger Setup]
    B -- Fail --> Z
    C -- Success --> D[Start SBI Server]
    C -- Fail --> Z
    D -- Success --> E[Register to NSF]
    D -- Fail --> Z
    E -- Success --> F{Has NX Interface?}
    E -- Fail --> Z
    F -- Yes --> G[Setup NX Interface]
    F -- No --> Y
    G -- Success --> Y
    G -- Faile --> Z
```

### 2.2 NF Stop

```mermaid
graph LR
    Z(NF Stopped)

    A(Stop NF) --> B{Has NX Interface}
    B -- Yes --> C[Close NX Interface]
    B -- No --> D[De-register to NSF]
    C --> D
    D --> E[Stop SBI Server]
    E --> Z
```

## 3. NF Service Access

```mermaid
sequenceDiagram
    autonumber
    participant con as Consumer
    participant nsf as NSF
    participant pro as Processor

    con ->>+ nsf: NNSF_NF_DISCOVERY_REQUEST
    nsf -->>- con: NNSF_NF_DISCOVERY_REPLY
    con ->>+ pro: NXXX_SERVICE_REQUEST
    pro -->>- con: NXXX_SERVICE_REPLY
```

## 4. Identity Initialization/Registeration/De-registeration

### 4.1 Identity Initialization

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF
    participant oam as OAM

    id ->>+ oam: JWT Download Request
    oam ->>+ drf: NDRF_JWT_QUERY_REQUEST
    drf -->>- oam: NDRF_JWT_QUERY_REPLY
    oam -->>- id: JWT Download Reply

    id ->>+ amf: IAP_INITIALZATION_REQUEST
    amf ->>+ pkf: NPKF_JWT_VALIDATION_REQUEST
    pkf ->>+ drf: NDRF_JWT_DELETE_REQUEST
    drf -->>- pkf: NDRF_JWT_DELETE_REPLY
    pkf -->>- amf: NPKF_JWT_VALIDATION_REPLY
    amf ->>+ pkf: NPKF_CERT_GENERATION_REQUEST
    pkf -->>- amf: NPKF_CERT_GENERATION_REPLY
    amf -->>- id: IAP_INITIALZATION_ACCEPT
```

### 4.2 Identity Registration

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_REGISTRATION_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_ACK
    amf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- amf: NDRF_IDENTITY_UPDATE_ACK
    amf -->>- id: IAP_REGISTRATION_ACCEPT
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

### 4.3 Identity De-registration

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant pkf as PKF
    participant drf as DRF

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_DE_REGISTRATION_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_ACK
    amf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- amf: NDRF_IDENTITY_UPDATE_ACK
    amf -->>- id: IAP_DE_REGISTRATION_ACCEPT
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

## 5. Router Session Establishment/Release

### 5.1 Router Session Establishment

```mermaid
sequenceDiagram
    autonumber

    participant rt as Router
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF

    Note over rt, smf: Establish Secure Channel (TLS 1.3)
    rt ->>+ smf: RAP_SESSION_ESTABLISHMENT_REQUEST
    smf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- smf: NPKF_CERT_VALIDATION_ACK
    smf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- smf: NDRF_IDENTITY_UPDATE_ACK
    smf -->>- rt: RAP_SESSION_ESTABLISHMENT_ACCEPT
    Note over rt, smf: Release Secure Channel (TLS 1.3)
    Note over rt, smf: Router Session Establishment
```

### 5.2 Router Session Release

```mermaid
sequenceDiagram
    autonumber

    participant rt as Router
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF

    Note over rt, smf: Establish Secure Channel (TLS 1.3)
    rt ->>+ smf: RAP_SESSION_RELEASE_REQUEST
    smf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- smf: NPKF_CERT_VALIDATION_ACK
    smf ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- smf: NDRF_IDENTITY_UPDATE_ACK
    smf -->>- rt: RAP_SESSION_RELEASE_ACCEPT
    Note over rt, smf: Release Secure Channel (TLS 1.3)
    Note over rt, smf: Router Session Release
```

## 6. Session Establishment/Modification/Release

### 6.1 Session Establishment

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant drf as DRF
    participant rt as Router

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_SESSION_ESTABLISHMENT_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_ACK
    amf ->>+ smf: NSMF_SESSION_ESTABLISHMENT_REQUEST
    smf ->>+ drf: NDRF_SESSION_DATA_REQUEST
    drf -->>- smf: NDRF_SESSION_DATA_REPLY
    smf ->>+ rt: SMP_SESSION_ESTABLISHMENT_REQUEST
    rt -->>- smf: SMP_SESSION_ESTABLISHMENT_ACK
    smf -->>- amf: NSMF_SESSION_ESTABLISHMENT_ACCEPT
    amf -->>- id: IAP_SESSION_ESTABLISHMENT_ACCEPT
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

### 6.2 Session Modification

```mermaid
sequenceDiagram
    autonumber

    participant smf as SMF
    participant drf as DRF
    participant oam as OAM
    participant mrt as Modify-Router
    participant ert as Establish-Router
    participant rrt as Release-Router

    oam ->>+ drf: NDRF_IDENTITY_UPDATE_REQUEST
    drf -->>- oam: NDRF_IDENTITY_UPDATE_ACK
    oam ->>+ smf: NSMF_SESSION_UPDATE_REQUEST
    smf ->>+ drf: NDRF_SESSION_DATA_REQUEST
    drf -->>- smf: NDRF_SESSION_DATA_REPLY
    par
        smf ->>+ mrt: SMP_SESSION_MODIFY_REQUEST
        mrt -->>- smf: SMP_SESSION_MODIFY_ACK
    and
        smf ->>+ ert: SMP_SESSION_ESTABLISHMENT_REQUEST
        ert -->>- smf: SMP_SESSION_ESTABLISHMENT_ACK
    and
        smf ->>+ rrt: SMP_SESSION_RELEASE_REQUEST
        rrt -->>- smf: SMP_SESSION_RELEASE_ACK
    end
    smf -->>- oam: NSMF_SESSION_UPDATE_ACK
```

### 6.3 Session Release

```mermaid
sequenceDiagram
    autonumber

    participant id as Identity
    participant amf as AMF
    participant smf as SMF
    participant pkf as PKF
    participant rt as Router

    Note over id, amf: Establish Secure Channel (TLS 1.3)
    id ->>+ amf: IAP_SESSION_RELEASE_REQUEST
    amf ->>+ pkf: NPKF_CERT_VALIDATION_REQUEST
    pkf -->>- amf: NPKF_CERT_VALIDATION_ACK
    amf ->>+ smf: NSMF_SESSION_RELEASE_REQUEST
    smf ->>+ rt: SMP_SESSION_RELEASE_REQUEST
    rt -->>- smf: SMP_SESSION_RELEASE_ACK
    smf -->>- amf: NSMF_SESSION_RELEASE_ACCEPT
    amf -->>- id: IAP_SESSION_RELEASE_ACCEPT
    Note over id, amf: Release Secure Channel (TLS 1.3)
```

## 7. OAM Interaction

## 7.1 Identity Creation/Modification/Delete

### 7.1.1 Identity Creation

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF
    participant pkf as PKF

    oam ->>+ drf: NDRF_IDENTITY_INSERT_RQUEST
    drf -->>- oam: NDRF_IDENTITY_INSERT_ACK
    oam ->>+ pkf: NPKF_JWT_GENERATION_REQUEST
    pkf -->>- oam: NPKF_JWT_GENERATION_REPLY
    oam ->>+ drf: NDRF_JWT_INSERT_REQUEST
    drf -->>- oam: NDRF_JWT_INSERT_ACK
```

### 7.1.2 Identity Modification

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF


    oam ->>+ drf: NDRF_IDENTITY_UPDATE_RQUEST
    drf -->>- oam: NDRF_IDENTITY_UPDATE_ACK
```

### 7.1.3 Identity Delete

```mermaid
sequenceDiagram
    autonumber

    participant oam as OAM
    participant drf as DRF
    oam ->>+ drf: NDRF_IDENTITY_DELETE_RQUEST
    drf -->>- oam: NDRF_IDENTITY_DELETE_ACK
```

## 8. QUIC Forward
